name: Deploy Cloud Functions

on:
  push:
    branches:
      - main
    paths:
      - 'functions/**'
      - 'src/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:  # 수동 실행 가능

env:
  PROJECT_ID: naver-webtoon-collector
  REGION: asia-northeast3
  SERVICE_ACCOUNT: webtoon-collector@naver-webtoon-collector.iam.gserviceaccount.com

jobs:
  deploy-pipeline-function:
    name: Deploy Pipeline Function
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Authenticate to Google Cloud
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          echo "$GCP_SA_KEY" > $HOME/gcloud-service-key.json
          gcloud auth activate-service-account --key-file=$HOME/gcloud-service-key.json
          gcloud config set project ${{ env.PROJECT_ID }}
          rm -f $HOME/gcloud-service-key.json

      - name: Prepare pipeline function
        working-directory: functions/pipeline_function
        run: |
          # src 디렉토리 복사
          if [ -d "../../src" ]; then
            cp -r ../../src .
          fi

      - name: Deploy Pipeline Function
        working-directory: functions/pipeline_function
        env:
          GCS_BUCKET_NAME: naver-webtoon-raw
          BIGQUERY_PROJECT_ID: ${{ env.PROJECT_ID }}
          BIGQUERY_DATASET_ID: naver_webtoon
        run: |
          # Gen2 함수는 Cloud Run 서비스로 배포되므로 run services로 확인
          echo "기존 함수 확인 중..."
          if gcloud run services describe pipeline-function --region=${{ env.REGION }} --project=${{ env.PROJECT_ID }} &>/dev/null; then
            echo "기존 함수 발견, 삭제 후 재배포..."
            # 기존 함수 삭제 (409 오류 방지)
            gcloud run services delete pipeline-function \
              --region=${{ env.REGION }} \
              --project=${{ env.PROJECT_ID }} \
              --quiet || echo "⚠️  삭제 실패 (이미 삭제되었을 수 있음)"
            echo "기존 함수 삭제 완료, 잠시 대기..."
            sleep 5
          else
            echo "새 함수 배포 중..."
          fi
          
          # 함수 배포
          gcloud functions deploy pipeline-function \
            --gen2 \
            --runtime=python311 \
            --region=${{ env.REGION }} \
            --source=. \
            --entry-point=main \
            --trigger-http \
            --allow-unauthenticated \
            --timeout=3600s \
            --memory=512MB \
            --set-env-vars "GCS_BUCKET_NAME=$GCS_BUCKET_NAME,BIGQUERY_PROJECT_ID=$BIGQUERY_PROJECT_ID,BIGQUERY_DATASET_ID=$BIGQUERY_DATASET_ID,DATA_FORMAT=jsonl" \
            --service-account=${{ env.SERVICE_ACCOUNT }} \
            --max-instances=1

  deploy-data-validation-function:
    name: Deploy Data Validation Function
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Authenticate to Google Cloud
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          echo "$GCP_SA_KEY" > $HOME/gcloud-service-key.json
          gcloud auth activate-service-account --key-file=$HOME/gcloud-service-key.json
          gcloud config set project ${{ env.PROJECT_ID }}
          rm -f $HOME/gcloud-service-key.json

      - name: Deploy Data Validation Function
        working-directory: functions/data_validation_function
        env:
          GCP_PROJECT_ID: ${{ env.PROJECT_ID }}
          GCP_REGION: ${{ env.REGION }}
          BIGQUERY_PROJECT_ID: ${{ env.PROJECT_ID }}
          BIGQUERY_DATASET_ID: naver_webtoon
          MIN_EXPECTED_RECORDS: 500
          NOTIFICATION_CHANNEL_EMAIL: ${{ secrets.NOTIFICATION_CHANNEL_EMAIL }}
        run: |
          # Gen2 함수는 Cloud Run 서비스로 배포되므로 run services로 확인
          echo "기존 함수 확인 중..."
          if gcloud run services describe data-validation-function --region=${{ env.REGION }} --project=${{ env.PROJECT_ID }} &>/dev/null; then
            echo "기존 함수 발견, 삭제 후 재배포..."
            # 기존 함수 삭제 (409 오류 방지)
            gcloud run services delete data-validation-function \
              --region=${{ env.REGION }} \
              --project=${{ env.PROJECT_ID }} \
              --quiet || echo "⚠️  삭제 실패 (이미 삭제되었을 수 있음)"
            echo "기존 함수 삭제 완료, 잠시 대기..."
            sleep 5
          else
            echo "새 함수 배포 중..."
          fi
          
          # 함수 배포
          gcloud functions deploy data-validation-function \
            --gen2 \
            --runtime=python311 \
            --region=${{ env.REGION }} \
            --source=. \
            --entry-point=main \
            --trigger-http \
            --allow-unauthenticated \
            --service-account=${{ env.SERVICE_ACCOUNT }} \
            --timeout=540s \
            --memory=256MB \
            --max-instances=1 \
            --set-env-vars "BIGQUERY_PROJECT_ID=$BIGQUERY_PROJECT_ID,BIGQUERY_DATASET_ID=$BIGQUERY_DATASET_ID,MIN_EXPECTED_RECORDS=$MIN_EXPECTED_RECORDS,NOTIFICATION_CHANNEL_EMAIL=$NOTIFICATION_CHANNEL_EMAIL"

