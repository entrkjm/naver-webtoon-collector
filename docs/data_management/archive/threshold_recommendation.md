# 데이터 수집 실패 감지 임계값 권장사항

## 현재 상황 분석

### 실제 수집 데이터 기준
- **정상 수집량**: 약 739개 웹툰
- **fact_weekly_chart**: 약 772개 레코드 (739개 × 2 정렬 타입)
- **fact_webtoon_stats**: 약 744개 레코드 (739개 고유 웹툰)

### 사용자 관찰
- **성공 시**: 거의 전수 수집 (대부분의 웹툰 수집)
- **실패 시**: 0개 또는 매우 적은 수 (10-50개 정도)
- **부분 실패**: 거의 발생하지 않음

## 임계값 권장사항

### 옵션 1: 보수적 접근 (권장)
**임계값: 500개**

**장점**:
- 웹툰 수가 자연스럽게 줄어들어도 오탐 방지
- 실제 실패(0개 또는 소수)는 확실히 감지
- 여유 있는 기준으로 안정적

**단점**:
- 매우 큰 부분 실패(500-700개 사이)는 감지하지 못할 수 있음

**적용 시나리오**:
- 웹툰 수가 600개로 줄어들어도 정상으로 판단
- 500개 미만이면 확실히 실패로 판단

### 옵션 2: 균형 접근
**임계값: 600개**

**장점**:
- 보수적 접근과 적극적 접근의 균형
- 중간 정도의 부분 실패도 감지 가능

**단점**:
- 웹툰 수가 650개로 줄어들면 오탐 가능성

**적용 시나리오**:
- 웹툰 수가 650개 이상이면 정상
- 600개 미만이면 실패로 판단

### 옵션 3: 적극적 접근
**임계값: 400개**

**장점**:
- 웹툰 수가 크게 줄어들어도 오탐 없음
- 부분 실패도 더 잘 감지

**단점**:
- 큰 부분 실패(400-600개)를 놓칠 수 있음

**적용 시나리오**:
- 웹툰 수가 500개로 줄어들어도 정상
- 400개 미만이면 실패로 판단

## 최종 권장사항

### 추천: **500개**

**이유**:
1. **실패 패턴 분석**: 사용자 관찰에 따르면 실패 시 0개 또는 소수(10-50개)만 수집됨
2. **성공 패턴**: 성공 시 거의 전수 수집 (700개 이상)
3. **여유 확보**: 웹툰 수가 자연스럽게 줄어들어도 오탐 방지
4. **실용성**: 500개 미만이면 확실히 비정상 상태

### 임계값별 감지 능력 비교

| 임계값 | 웹툰 수 감소 허용 | 부분 실패 감지 | 오탐 가능성 |
|--------|------------------|----------------|-------------|
| 700개  | 39개 (5%)        | 높음           | 높음        |
| 600개  | 139개 (19%)      | 중간           | 중간        |
| **500개** | **239개 (32%)** | **낮음**       | **낮음**    |
| 400개  | 339개 (46%)      | 매우 낮음      | 매우 낮음   |

## 적용 방법

### 방법 1: 환경 변수로 설정 (권장)

```bash
# 배포 시 임계값 설정
export MIN_EXPECTED_RECORDS=500
cd functions/data_validation_function
./deploy.sh
```

### 방법 2: 코드 기본값 변경

```python
# functions/data_validation_function/main.py
MIN_EXPECTED_RECORDS = int(os.environ.get("MIN_EXPECTED_RECORDS", "500"))  # 700 → 500
```

### 방법 3: Cloud Function 환경 변수 직접 설정

```bash
gcloud functions deploy data-validation-function \
  --gen2 \
  --region=asia-northeast3 \
  --update-env-vars MIN_EXPECTED_RECORDS=500
```

## 모니터링 및 조정

### 정기적 검토
- 월 1회 수집량 통계 확인
- 웹툰 수 추이 모니터링
- 필요 시 임계값 조정

### 조정 기준
- **웹툰 수가 지속적으로 감소**: 임계값 낮춤
- **부분 실패가 자주 발생**: 임계값 높임
- **오탐이 자주 발생**: 임계값 낮춤

## 참고

- 현재 정상 수집량: 739개 웹툰
- 권장 임계값: 500개 (약 68% 수준)
- 최소 허용량: 500개 미만이면 확실히 실패로 판단

